#include "zigzag.h"

// Zigzag code permutation table
const uint8_t n[4][128] =
{
    {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127},
    {104,52,43,96,31,7,71,78,58,37,93,25,125,85,42,111,6,95,72,117,27,51,63,84,91,35,120,26,97,45,110,70,1,28,86,114,53,67,12,127,40,101,73,94,115,61,20,126,3,46,92,116,9,56,87,77,109,44,65,54,100,118,2,34,21,41,76,14,69,124,90,18,103,48,113,36,0,81,13,62,24,38,105,68,15,75,88,50,122,29,83,102,8,16,108,23,32,49,99,112,19,55,89,11,107,82,47,98,22,30,60,80,66,121,10,57,17,39,79,4,64,123,33,59,106,74,5,119},
    {26,10,105,48,38,84,76,57,23,125,115,3,106,33,77,99,71,113,22,1,44,87,8,31,111,96,2,42,70,81,13,93,122,37,114,88,63,107,50,40,82,116,68,6,127,16,51,73,61,83,46,0,126,104,78,67,41,119,28,11,56,47,4,21,52,66,15,98,24,7,30,91,112,35,55,124,64,5,95,32,49,9,85,65,43,18,92,36,12,86,118,60,25,72,53,80,123,45,58,102,110,120,89,34,17,75,94,27,100,62,20,39,108,90,69,117,97,59,79,109,101,19,121,54,29,14,74,103},
    {0,93,104,36,87,125,23,97,44,107,11,3,70,35,60,77,29,84,6,91,126,15,76,56,4,89,115,99,43,22,122,16,105,55,2,113,78,51,63,14,120,102,8,19,68,111,86,47,64,32,121,72,59,108,96,80,25,67,118,12,58,127,20,90,9,37,103,53,62,69,85,10,110,34,100,119,39,73,1,83,48,112,30,54,65,45,5,123,101,26,88,18,46,95,40,109,7,27,57,66,116,38,75,92,21,52,61,28,106,114,94,33,17,79,42,71,124,50,82,13,31,41,117,74,98,81,24,49}
};

void ZIGZAG_Append(uint8_t __xdata* src_buf, uint8_t __xdata* dst_buf, bool parity)
{
    uint8_t b0;     // source bit 0
    uint8_t b1;     // source bit 0
    uint8_t bprev;  // previous result bit
    uint8_t res;    // result bit

    // Code[N] is zigzag code for Nth permutation
    uint8_t code[4][8]={{0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0}};

    // Calculate zigzag code for each permutation
    for(int j=0; j<4; j++)
    {
        for(uint8_t i=0; i<64; i++) // Payload 16bytes, each zigzag code 8bytes
        {
            b0      = (src_buf[ n[j][ i ]  /8] << ( n[j][ i ]  %8)) & 0x80;
            b1      = (src_buf[ n[j][64+i] /8] << ( n[j][64+i] %8)) & 0x80;
            bprev   = (code[j][   (i-1)    /8] << (   (i-1)    %8)) & 0x80;
            res     =  b0 ^ b1 ^ bprev;
            code[j][i/8] |= res >> (i%8);
        }
    }

    // Cppend result to dst_buf
    for(int i=0; i<8;i++)
    {
        // Depending on parity, use either odd or even parts of zigzag code
        dst_buf[i]      = (code[0][i] & (parity ? 0xAA : 0x55)) | (code[1][i] & (parity ? 0x55 : 0xAA));
        dst_buf[i+8]    = (code[2][i] & (parity ? 0xAA : 0x55)) | (code[3][i] & (parity ? 0x55 : 0xAA));
    }
}
